#!/usr/bin/env bash
#
# open vim on a 9p file
# - read the file locally to a temp file
# - edit
# - write the file back to the same location on 9p
#
# 9p rdwr mode should work, but probably needs ':w!tee' to write
# socat+9p rdwr w/pipe+exec continuously reads/rewrites the remote
# vipe from moreutils may work? http://joeyh.name/code/moreutils/
# should this be "edit9p"?
#

set -eu
set -o pipefail

: ${vim9pdebug:="false"}
: ${ninepcmd:="9p"}
: ${ninepargs:=""}
: ${vimcmd:="vim"}
: ${vimargs:=""}
: ${rmtempfile:="false"}

scriptname="$(basename $(realpath "${BASH_SOURCE[0]}"))"

function failexit() {
  echo "${scriptname}: failure: ${@}"
  exit 1
}

for c in "${ninepcmd## *}" "${vimcmd## *}" ; do
  command -v "${c}" &>/dev/null || failexit "${c} not found"
done

function checkdebug() {
  test "${vim9pdebug}" == "true"
}

function debugecho() {
  checkdebug && echo "${@}" | tr -s ' ' 1>&2 || true
}

declare -a args=()
for ((i=0;${#}>0;i++)) ; do args["${i}"]="${1}" ; shift ; done
for ((i=0;i<${#args[${i}]};i++)) ; do debugecho "args[${i}]: ${args[$i]}" ; done ;

declare -i la="((${#args[@]}-1))"
debugecho "lastarg: ${lastarg}"

declare ninepuri="${args[${lastarg}]}"
debugecho "ninepuri: ${ninepuri}"

declare ninepaddr="${ninepuri%:*}"
debugecho "ninepaddr: ${ninepaddr}"

declare ninepfile="${ninepuri##*:}"
debugecho "ninepfile: ${ninepfile}"

declare tempfile="$(mktemp)"
debugecho "tempfile: ${tempfile}"
debugecho "tempfile: replacing ${args[${lastarg}]} with ${tempfile} to pass to vim"
args[${lastarg}]="${tempfile}"

debugecho "9p read cmdline: ${ninepcmd} ${ninepargs} -a ${ninepaddr} read ${ninepfile}"
"${ninepcmd}" ${ninepargs} -a "${ninepaddr}" read "${ninepfile}" > "${tempfile}" || failexit "could not read ${ninepuri} to ${tempfile}"
debugecho "read: successfully read ${ninepuri} to ${tempfile}"

debugecho "vim cmdline: ${vimcmd} ${vimargs} ${args[@]}"
"${vimcmd}" ${vimargs} ${args[@]} || failexit "vim exited with non-zero status"
debugecho "vim: exited cleanly"

debugecho "9p write cmdline: ${ninepcmd} ${ninepargs} -a ${ninepaddr} write ${ninepfile}"
"${ninepcmd}" ${ninepargs} -a "${ninepaddr}" write "${ninepfile}" < "${tempfile}" || failexit "could not from ${tempfile} to ${ninepuri}"
debugecho "write: successfully wrote ${tempfile} to ${ninepuri}"

if [[ "${rmtempfile}" == "true" ]] ; then
  debugecho "rmtempfile: true, removing ${tempfile}"
  rm -f "${tempfile}" || failexit "could not remove ${tempfile}"
fi
debugecho "rmtempfile: succesfully removed ${tempfile}"
